name: Build MPD for Alpine Linux

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'v0.24.5'
        required: false
  push:
    branches:
      - main
    tags:
      - "v*"

jobs:
  build-alpine:
    runs-on: ubuntu-latest

    container:
      image: alpine:3.22

    steps:
      - name: Install build tools
        run: |
          apk update
          apk add --no-cache \
            alpine-sdk \
            meson \
            ninja \
            bash \
            curl-dev \
            git \
            musl-dev \
            pkgconfig \
            boost-dev \
            avahi-dev \
            libupnp-dev \
            libmad-dev \
            flac-dev \
            opus-dev \
            libvorbis-dev \
            sqlite-dev \
            samba-dev

      - name: Checkout MPD
        run: |
          git clone https://github.com/MusicPlayerDaemon/MPD.git
          cd MPD
          git fetch --tags

      - name: Build MPD
        working-directory: MPD
        run: |
          meson setup build \
            --buildtype=release \
            -Dsysconfdir='/etc' \
            -Dsnapcast=true \
            -Dupnp=pupnp \
            -Dsqlite=enabled
          ninja -C build

      - name: Install MPD into package root
        run: |
          mkdir -p pkgroot
          cd MPD/build
          DESTDIR="$(pwd)/../../pkgroot" ninja install

      - name: Create APK metadata
        run: |
          mkdir -p apkbuild/CONTROL
          cat > apkbuild/CONTROL/control <<EOF
          Package: mpd-snapcast
          Version: 0.24.5-r0
          Architecture: x86_64
          License: GPL-2.0-or-later
          Maintainer: You
          Description: MPD compiled with snapcast support
          EOF

      - name: Build APK manually (Alpine 3.22 compatible)
        run: |
          # Create control.tar.gz
          tar -C apkbuild/CONTROL -czf control.tar.gz .
          # Create data.tar.gz from pkgroot
          tar -C pkgroot -czf data.tar.gz .
          # Build the final .apk = simple tar
          tar -czf mpd-snapcast.apk control.tar.gz data.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mpd-snapcast-apk
          path: mpd-snapcast.apk

      - name: Create Release and upload APK (tag or manual)
        if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && inputs.release_tag != '')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || inputs.release_tag }}
          files: mpd-snapcast.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


